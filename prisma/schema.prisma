// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  LANDLORD
  TENANT
}

enum SubscriptionPlan {
  FREE_TRIAL
  BASIC
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  FAILED
}

enum MaintenanceStatus {
  SUBMITTED
  IN_PROGRESS
  RESOLVED
}

enum TransactionStatus {
  SUCCESS
  INPROGRESS
  AMBIGUOUS
  FAIL
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  phone         String?
  role          UserRole  @default(TENANT)
  profileImage  String?
  
  // Landlord specific
  landlordProfileComplete Boolean @default(false)
  createdAtBy            String? // Super Admin ID who created this landlord
  
  // Tenant specific
  tenantProfileComplete Boolean @default(false)
  
  // Relationships
  landlordProperties    Property[]           @relation("LandlordProperties")
  tenantUnits          UnitTenant[]         @relation("TenantUnits") // Many-to-many with units
  subscription          Subscription?
  payments              Payment[]
  maintenanceRequests   MaintenanceRequest[]
  leaseAgreements       LeaseAgreement[]
  auditLogs             AuditLog[]
  announcementsSent     Announcement[]           @relation("LandlordAnnouncements")
  announcementsReceived AnnouncementRecipient[] @relation("TenantAnnouncements")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([role])
}

model Property {
  id          String   @id @default(cuid())
  address     String
  location    String?  // Location/City/Area
  latitude    Float?   // Google Maps latitude
  longitude   Float?   // Google Maps longitude
  propertyType String // "single" or "multi"
  description String?
  photos      String[] // Array of photo URLs
  landlordId  String
  
  // Relationships
  landlord    User   @relation("LandlordProperties", fields: [landlordId], references: [id])
  units       Unit[]
  announcements Announcement[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([landlordId])
}

model Unit {
  id              String   @id @default(cuid())
  propertyId      String
  unitNumber      String   // e.g., "1A", "1B", "2A"
  floor           Int?
  rentAmount      Float
  leaseStartDate  DateTime?
  leaseEndDate    DateTime?
  invitationToken String   @unique // Unique token for invitation link
  isOccupied      Boolean  @default(false)
  
  // Relationships
  property          Property            @relation(fields: [propertyId], references: [id])
  tenants           UnitTenant[]        // Many-to-many with tenants
  payments          Payment[]
  maintenanceRequests MaintenanceRequest[]
  leaseAgreements   LeaseAgreement[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([propertyId])
  @@index([isOccupied])
}

// Join table for many-to-many relationship between Unit and Tenant
model UnitTenant {
  id        String   @id @default(cuid())
  unitId    String
  tenantId  String
  
  // Relationships
  unit      Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  tenant    User     @relation("TenantUnits", fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([unitId, tenantId]) // Prevent duplicate assignments
  @@index([unitId])
  @@index([tenantId])
}

model Subscription {
  id              String            @id @default(cuid())
  userId          String            @unique
  plan            SubscriptionPlan  @default(FREE_TRIAL)
  status          SubscriptionStatus @default(ACTIVE)
  trialStartDate  DateTime?
  trialEndDate    DateTime?
  billingCycleStart DateTime?
  billingCycleEnd   DateTime?
  nextBillingDate  DateTime?
  membershipPaid  Boolean           @default(false)
  membershipPaymentDate DateTime?
  membershipAmount Float            @default(80.00) // $80 USD
  
  // Relationships
  user            User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Payment {
  id                String        @id @default(cuid())
  unitId            String
  tenantId          String
  amount            Float
  dueDate           DateTime
  paidDate          DateTime?
  status            PaymentStatus @default(PENDING)
  editedAt          DateTime?     // Track when payment was edited
  
  // Selcom integration
  transactionId    String?       @unique
  selcomReference  String?
  selcomResultCode String?
  transactionStatus TransactionStatus?
  receiptUrl       String?
  
  // Relationships
  unit              Unit          @relation(fields: [unitId], references: [id])
  tenant            User          @relation(fields: [tenantId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([unitId])
  @@index([tenantId])
  @@index([status])
  @@index([dueDate])
}

model MaintenanceRequest {
  id          String            @id @default(cuid())
  unitId      String
  tenantId    String
  title       String
  description String
  photos      String[]          // Array of photo URLs
  status      MaintenanceStatus @default(SUBMITTED)
  resolutionNotes String?
  resolutionPhotos String[]     // Landlord's resolution photos
  
  // Relationships
  unit              Unit          @relation(fields: [unitId], references: [id])
  tenant            User          @relation(fields: [tenantId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  resolvedAt  DateTime?
  
  @@index([unitId])
  @@index([tenantId])
  @@index([status])
}

model LeaseAgreement {
  id          String   @id @default(cuid())
  unitId      String
  tenantId    String
  documentUrl String   // PDF or image URL
  startDate   DateTime
  endDate     DateTime
  
  // Relationships
  unit              Unit          @relation(fields: [unitId], references: [id])
  tenant            User          @relation(fields: [tenantId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([unitId])
  @@index([tenantId])
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   // e.g., "CREATE_PROPERTY", "UPDATE_PAYMENT", "DELETE_TENANT"
  entityType  String   // e.g., "Property", "Payment", "User"
  entityId    String
  details     Json?    // Additional details about the action
  ipAddress   String?
  userAgent   String?
  
  // Relationships
  user            User          @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
}

model Announcement {
  id          String   @id @default(cuid())
  landlordId  String
  propertyId  String?  // null = all properties
  title       String
  message     String
  targetType  String   // "ALL_TENANTS" | "SPECIFIC_TENANTS" | "PROPERTY_TENANTS"
  tenantIds   String[] // Array of tenant IDs if targetType is SPECIFIC_TENANTS
  
  // Relationships
  landlord    User     @relation("LandlordAnnouncements", fields: [landlordId], references: [id])
  property    Property? @relation(fields: [propertyId], references: [id])
  recipients  AnnouncementRecipient[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([landlordId])
  @@index([propertyId])
}

// Track which tenants received which announcements
model AnnouncementRecipient {
  id             String       @id @default(cuid())
  announcementId String
  tenantId       String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  
  // Relationships
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  tenant         User         @relation("TenantAnnouncements", fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime     @default(now())
  
  @@unique([announcementId, tenantId])
  @@index([tenantId])
  @@index([announcementId])
}

